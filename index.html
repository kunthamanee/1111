<!DOCTYPE html>
<html>
<head>
  <title>Teachable Machine + MQTT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
    #webcam-container { max-width: 100%; margin: 10px auto; }
    video { max-width: 100%; height: auto; }
    #label-container { margin: 10px; font-size: 1.2em; }
    button { padding: 10px 20px; font-size: 1em; margin: 5px; }
  </style>
</head>
<body>
  <div>Teachable Machine + MQTT</div>
  <button onclick="init('environment')">Start (Back Camera)</button>
  <button onclick="init('user')">Start (Front Camera)</button>
  <button onclick="stop()">Stop</button>
  <div id="webcam-container"></div>
  <div id="label-container"></div>

  <script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/klxDOYTDp/";
    let model, webcam, labelContainer, maxPredictions;
    let lastSentClass = "";
    let sending = false;

    // MQTT
    const clientID = "web_" + Math.floor(Math.random() * 10000);
    const client = new Paho.MQTT.Client("broker.hivemq.com", 8884, clientID);
    client.connect({
      useSSL: true,
      onSuccess: () => console.log("MQTT Connected"),
      onFailure: e => console.error("MQTT failed:", e.errorMessage)
    });

    function sendMQTTMessage(message) {
      const mqttMessage = new Paho.MQTT.Message(message);
      mqttMessage.destinationName = "ktmn";
      client.send(mqttMessage);
      console.log("Sent to ktmn:", message);
    }

    async function init(facingMode) {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      webcam = new tmImage.Webcam(224, 224, false);
      await webcam.setup({ facingMode });
      await webcam.play();
      window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").innerHTML = '';
      document.getElementById("webcam-container").appendChild(webcam.canvas);
      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }
    }

    async function loop() {
      webcam.update();
      await predict();
      if (!sending) window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let highest = prediction[0];
      for (let i = 1; i < prediction.length; i++) {
        if (prediction[i].probability > highest.probability) {
          highest = prediction[i];
        }
      }

      for (let i = 0; i < maxPredictions; i++) {
        const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
        labelContainer.childNodes[i].innerHTML = classPrediction;
      }

      // ถ้าเจอ class ที่มีความมั่นใจ >= 0.9 และยังไม่ส่ง
      if (highest.probability >= 0.9 && highest.className !== lastSentClass) {
        sending = true;
        lastSentClass = highest.className;

        // ค้างผล 5 วิ
        setTimeout(() => {
          // ส่ง MQTT หลังจากผ่านไป 3 วิ
          sendMQTTMessage(highest.className);

          // เริ่ม loop ใหม่หลังจากค้างรวม 5 วิ
          setTimeout(() => {
            sending = false;
            window.requestAnimationFrame(loop);
          }, 2000); // 5 - 3 = 2 วินาทีที่เหลือ
        }, 3000); // รอ 3 วิ ก่อนส่ง
      }
    }

    function stop() {
      if (webcam) {
        webcam.stop();
        document.getElementById("webcam-container").innerHTML = '';
        document.getElementById("label-container").innerHTML = '';
        sending = false;
        lastSentClass = "";
      }
    }
  </script>
</body>
</html>
